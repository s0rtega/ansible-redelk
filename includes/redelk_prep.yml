---

  - hosts: localhost
    vars_files:
      - ../vars/redelk.yml
    gather_facts: false
    tags: [prep]
  
    tasks:
      - set_fact: script_dest="/tmp/redelk_latest/c2servers/filebeat/filebeat_{{c2type}}.yml"
      - name: Downloading Latest RedElk to /tmp
        shell: curl -s https://api.github.com/repos/outflanknl/redelk/releases/latest | grep tarball_url | cut -d'"' -f4 | wget -O /tmp/redelk_latest.tgz -qi -
        args:
          warn: false
        tags: [prep_download]
  
      # Using tar command instead of unarchive module, which threw errors every time.
      - name: Extracting
        shell: mkdir -p /tmp/redelk_latest && tar -zxvf /tmp/redelk_latest.tgz -C /tmp/redelk_latest --strip-components=1
        args:
          warn: false
        tags: [prep_extract]
  
      - name: Updating certs/config.conf
        lineinfile:
          dest: /tmp/redelk_latest/certs/config.cnf
          regexp: "{{ item.regexp }}"
          line: "{{ item.line }}"
        with_items:
          - {regexp: '^C = ', line: 'C = {{ cert_C }}'}
          - {regexp: '^ST = ', line: 'ST = {{ cert_ST }}'}
          - {regexp: '^L = ', line: 'L = {{ cert_L }}'}
          - {regexp: '^O = ', line: 'O = {{ cert_O }}'}
          - {regexp: '^OU = ', line: 'OU = {{ cert_OU }}'}
          - {regexp: '^CN = ', line: 'CN = {{ cert_CN }}'}
          - {regexp: '^emailAddress = ', line: 'emailAddress = {{ cert_email }}'}
          - {regexp: '^DNS.1 = ', line: ""}
          - {regexp: '^DNS.2 = ', line: ""}
          - {regexp: '^IP.1 = ', line: 'IP.1 = {{ redelk_server_host }}'}
        tags: [prep_cert]
  
      - name: Updating RedElk c2servers path
        replace:
          path: "{{ item.dest }}"
          regexp: '\/root\/cobaltstrike'
          replace: "{{ c2type_install_dir }}"
        with_items:
          - {dest: '/tmp/redelk_latest/c2servers/filebeat/filebeat_{{c2type}}.yml'}
          - {dest: /tmp/redelk_latest/c2servers/scripts/copydownloads_cobaltstrike.sh}
          - {dest: /tmp/redelk_latest/c2servers/cron.d/redelk_cobaltstrike}
        tags: [prep_c2servers]
  
      - name: Executing RedElk init script.
        command:
          chdir: /tmp/redelk_latest
          cmd: ./initial-setup.sh ./certs/config.cnf
        register: exec_output
        ignore_errors: true
        tags: [prep_init]
  
      - name: Checking for failures
        fail:
          msg: "Error occurred. Check /tmp/redelk_latest/redelk-initialsetup.log for details."
        when: '"ERROR" in exec_output.stdout'
        tags: [prep_init]